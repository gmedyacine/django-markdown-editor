
# ------------------------------------------------------------------
# DEPLOY PROD (manuel, seulement sur "release tags")
# Ex: git tag v1.2.3 && git push origin v1.2.3
# ------------------------------------------------------------------
deploy_prod:
  stage: deploy
  needs: ["push-image"]             # adapte au nom de ton job qui pousse l'image
  when: manual                      # validation manuelle
  allow_failure: false
  environment:
    name: production
    # url: https://ton-app.prod.example.com   # optionnel
  rules:
    # 1) On n'exécute/affiche le job que si c'est un TAG de release (pattern vX.Y.Z)
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: manual
    # 2) Sinon, NE CRÉE PAS le job (il ne s'affiche pas dans la pipeline)
    - when: never
  script:
    # Exemple : déploiement Helm (remplace par tes commandes)
    - echo "Deploying ${CI_COMMIT_TAG} to production..."
    - helm upgrade --install app-prod ./helm/chart \
        --namespace apps-prod \
        --set image.tag="${CI_COMMIT_TAG}"
